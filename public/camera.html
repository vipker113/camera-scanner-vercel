<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scanner</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        background: #000;
        overflow: hidden;
      }
      #wrap {
        position: relative;
        width: 100%;
        height: 100%;
      }
      #video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #000;
      }
      #overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
    </style>
    <script src="https://unpkg.com/@zxing/library@0.21.2"></script>
    <script src="https://unpkg.com/@zxing/browser@0.2.4"></script>
  </head>
  <body>
    <div id="wrap">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>

    <script>
      const video = document.getElementById("video");
      const ZX = window.ZXingBrowser || window.ZXing;
      const { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } = ZX;

      let scanning = true;
      function post(msg) {
        try {
          if (window.ReactNativeWebView)
            window.ReactNativeWebView.postMessage(JSON.stringify(msg));
          else console.log("[RN]", msg);
        } catch (_) {}
      }

      window.__setScanning = (flag) => {
        scanning = !!flag;
      };

      async function start() {
        try {
          const hints = new Map();
          hints.set(DecodeHintType.POSSIBLE_FORMATS, [
            BarcodeFormat.CODE_128,
            BarcodeFormat.CODE_39,
            BarcodeFormat.EAN_13,
            BarcodeFormat.EAN_8,
            BarcodeFormat.UPC_A,
            BarcodeFormat.UPC_E,
            BarcodeFormat.ITF,
            BarcodeFormat.QR_CODE,
          ]);
          const reader = new BrowserMultiFormatReader(hints);

          const devices =
            await BrowserMultiFormatReader.listVideoInputDevices();

          let backCam = null;

          backCam = devices.find(
            (d) =>
              d.label.toLowerCase().includes("back") ||
              d.label.toLowerCase().includes("rear")
          );

          if (!backCam && devices.length > 1) {
            backCam = devices[devices.length - 1];
          }

          const deviceId = backCam ? backCam.deviceId : devices[0]?.deviceId;

          post({ type: "ready", deviceId });

          await reader.decodeFromVideoDevice(deviceId, video, (result) => {
            if (!scanning) return;
            if (result) {
              const text = result.getText?.() || result.text || "";
              post({ type: "scan", text, ts: Date.now() });
            }
          });
        } catch (e) {
          console.error(e);
          post({ type: "error", message: e.message || "Camera error" });
        }
      }
      start();
    </script>
  </body>
</html>
