<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Barcode Scanner</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        font-family: system-ui, sans-serif;
        overflow: hidden;
      }
      #wrap {
        position: relative;
        width: 100%;
        height: 100%;
      }
      #video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #000;
      }
      #overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
      .title {
        color: #fff;
        text-align: center;
        font-size: 18px;
        font-weight: 400;
        position: absolute;
        top: 60px;
        left: 0;
        right: 0;
        z-index: 5;
      }
      .title b {
        font-weight: 700;
      }
      .manual-btn {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9);
        color: #003040;
        border: none;
        border-radius: 999px;
        padding: 12px 20px;
        font-size: 14px;
        cursor: pointer;
        z-index: 5;
      }
      .close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: #fff;
        font-size: 28px;
        cursor: pointer;
        z-index: 5;
      }

      #scrim {
        position: absolute;
        inset: 0;
        background: rgba(7, 72, 94, 0.7);
        display: none;
        z-index: 8;
      }
      #manualModal {
        position: absolute;
        inset: 0;
        display: none;
        z-index: 9;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(92vw, 360px);
        background: #fff;
        color: #0b2530;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        padding: 18px;
      }
      .card h2 {
        margin: 4px 0 8px;
        font-size: 20px;
        font-weight: 600;
      }
      .card p {
        margin: 8px 0;
        font-size: 14px;
        color: #334a57;
        line-height: 1.35;
      }
      .field {
        margin-top: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #cbd5dc;
        border-radius: 6px;
        padding: 10px 12px;
      }
      .field input {
        border: none;
        outline: none;
        flex: 1;
        font-size: 16px;
        color: #102a36;
      }
      .helper {
        margin-top: 6px;
        font-size: 12px;
        color: #6b8796;
        padding-left: 4px;
      }
      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 16px;
      }
      .btn {
        border-radius: 999px;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid transparent;
      }
      .btn-ghost {
        background: #fff;
        border-color: #0b2530;
        color: #0b2530;
      }
      .btn-primary {
        background: #0b4254;
        color: #fff;
      }
      .clear-x {
        background: none;
        border: none;
        cursor: pointer;
        color: #7b8c97;
        font-size: 18px;
        line-height: 1;
      }
    </style>
    <script src="https://unpkg.com/@zxing/library@0.21.2"></script>
    <script src="https://unpkg.com/@zxing/browser@0.2.4"></script>
  </head>
  <body>
    <div id="wrap">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>

      <div class="title">
        Enter the barcode of the <b>first sachet</b><br />in the new roll.
      </div>

      <button class="manual-btn" id="openManualBtn">Enter code manually</button>
      <button class="close-btn" onclick="sendClose()">×</button>

      <div id="scrim"></div>
      <div id="manualModal" role="dialog" aria-modal="true">
        <div class="card">
          <h2>Enter Code Manually</h2>
          <p>
            Having trouble scanning the barcode? No worries! Just type in the
            sachet code below. You can find the code right under the barcode.
          </p>
          <div class="field">
            <input
              id="manualInput"
              type="text"
              placeholder="E.g. ABC123456789"
              maxlength="32"
            />
            <button class="clear-x" id="clearBtn" title="Clear">✕</button>
          </div>
          <div class="helper">Enter a 10-digit code.</div>
          <div class="actions">
            <button class="btn btn-ghost" id="cancelBtn">Cancel</button>
            <button class="btn btn-primary" id="confirmBtn" disabled>
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const video = document.getElementById("video");
      const overlay = document.getElementById("overlay");
      const ctx = overlay.getContext("2d");
      const ZX = window.ZXingBrowser || window.ZXing;
      const { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } = ZX;

      const scrim = document.getElementById("scrim");
      const modal = document.getElementById("manualModal");
      const openManualBtn = document.getElementById("openManualBtn");
      const inputEl = document.getElementById("manualInput");
      const cancelBtn = document.getElementById("cancelBtn");
      const confirmBtn = document.getElementById("confirmBtn");
      const clearBtn = document.getElementById("clearBtn");

      let reader = null;
      let scanning = true;

      function sendMessage(obj) {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify(obj));
        } else {
          console.log("[RN]", obj);
        }
      }
      function sendClose() {
        sendMessage({ type: "close" });
      }

      function drawMask(w, h, withHole = true) {
        const boxW = w * 0.5;
        const boxH = h * 0.5;
        const x = (w - boxW) / 2;
        const y = (h - boxH) / 2;

        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "rgba(22, 91, 118, 0.9)";
        ctx.fillRect(0, 0, w, h);

        if (withHole) {
          ctx.globalCompositeOperation = "destination-out";
          ctx.fillStyle = "#000";
          ctx.fillRect(x, y, boxW, boxH);
          ctx.globalCompositeOperation = "source-over";

          const r = 12,
            corner = 30,
            lw = 5;
          ctx.lineWidth = lw;
          ctx.strokeStyle = "#fff";
          ctx.beginPath();
          // TL
          ctx.moveTo(x, y + corner);
          ctx.lineTo(x, y + r);
          ctx.quadraticCurveTo(x, y, x + r, y);
          ctx.lineTo(x + corner, y);
          // TR
          ctx.moveTo(x + boxW - corner, y);
          ctx.lineTo(x + boxW - r, y);
          ctx.quadraticCurveTo(x + boxW, y, x + boxW, y + r);
          ctx.lineTo(x + boxW, y + corner);
          // BR
          ctx.moveTo(x + boxW, y + boxH - corner);
          ctx.lineTo(x + boxW, y + boxH - r);
          ctx.quadraticCurveTo(x + boxW, y + boxH, x + boxW - r, y + boxH);
          ctx.lineTo(x + boxW - corner, y + boxH);
          // BL
          ctx.moveTo(x + corner, y + boxH);
          ctx.lineTo(x + r, y + boxH);
          ctx.quadraticCurveTo(x, y + boxH, x, y + boxH - r);
          ctx.lineTo(x, y + boxH - corner);
          ctx.stroke();
        }
      }

      function resizeCanvas() {
        const cssW = video.clientWidth || window.innerWidth;
        const cssH = video.clientHeight || window.innerHeight;
        const dpr = window.devicePixelRatio || 1;
        overlay.width = cssW * dpr;
        overlay.height = cssH * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        drawMask(cssW, cssH, scanning);
      }
      window.addEventListener("resize", () =>
        requestAnimationFrame(resizeCanvas)
      );

      function openManual() {
        scanning = false;
        resizeCanvas();
        scrim.style.display = "block";
        modal.style.display = "flex";
        inputEl.value = "";
        confirmBtn.disabled = true;
        setTimeout(() => inputEl.focus(), 50);
      }
      function closeManual() {
        modal.style.display = "none";
        scrim.style.display = "none";
        scanning = true;
        resizeCanvas();
      }

      openManualBtn.addEventListener("click", openManual);
      cancelBtn.addEventListener("click", closeManual);
      clearBtn.addEventListener("click", () => {
        inputEl.value = "";
        inputEl.focus();
        confirmBtn.disabled = true;
      });
      inputEl.addEventListener("input", () => {
        confirmBtn.disabled = !inputEl.value.trim();
      });
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !confirmBtn.disabled) confirmBtn.click();
      });

      confirmBtn.addEventListener("click", () => {
        const text = inputEl.value.trim();
        if (!text) return;
        sendMessage({ type: "manual_submit", text });
        closeManual();
      });

      async function startScanner() {
        try {
          const hints = new Map();
          hints.set(DecodeHintType.POSSIBLE_FORMATS, [
            BarcodeFormat.CODE_128,
            BarcodeFormat.CODE_39,
            BarcodeFormat.EAN_13,
            BarcodeFormat.EAN_8,
            BarcodeFormat.UPC_A,
            BarcodeFormat.UPC_E,
            BarcodeFormat.ITF,
            BarcodeFormat.QR_CODE,
          ]);
          reader = new BrowserMultiFormatReader(hints);

          await reader.decodeFromVideoDevice(null, video, (result) => {
            resizeCanvas();
            if (!scanning) return;
            if (result) {
              const text = result.getText?.() || result.text || "";
              sendMessage({ type: "scan", text });
            }
          });
        } catch (e) {
          console.error(e);
          sendMessage({ type: "error", message: e.message });
        }
      }
      startScanner();
    </script>
  </body>
</html>
